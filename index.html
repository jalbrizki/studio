<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MadGazan Studio</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        max-width: 900px;
    }
    select, button {
        padding: 8px 12px;
        margin: 5px 0;
    }
    #output {
        margin-top: 10px;
        white-space: pre-wrap;
        background: #f7f7f7;
        border: 1px solid #ccc;
        padding: 12px;
    }
    #updateInfo {
        margin-top: 10px;
        font-weight: bold;
    }
</style>

</head>
<body>

<h2>MadGazan Studio</h2>

<label>Pilih Toko:</label><br>
<select id="tokoSelect" onchange="showSelectedData()"></select>

<br><br>

<button onclick="downloadSingle()">Download File Ini</button>
<button onclick="downloadAllAsZip()">Download Semua (ZIP)</button>
<button onclick="syncAllFiles()">Sync Semua → JSON</button>

<p id="updateInfo">Memuat...</p>

<h3>Isi Data:</h3>
<pre id="output"></pre>

<!-- ZIP LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
// ======================================================
//  GLOBAL VARIABLE
// ======================================================
let serverData = {};
let localData = {};


// ======================================================
//  LOAD SERVER JSON (madgazan_backup.json)
// ======================================================
async function loadServerBackup() {
    try {
        const res = await fetch("db/madgazan_backup.json");
        if (!res.ok) throw new Error("Gagal fetch JSON");

        serverData = await res.json();

        populateDropdown();
        checkForUpdates();

    } catch (e) {
        console.error(e);
        alert("Gagal memuat 'madgazan_backup.json'");
    }
}


// ======================================================
//  LOAD LOCAL STORAGE
// ======================================================
function loadLocalBackup() {
    localData = {};

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);

        if (key.startsWith("appData_")) {
            try {
                localData[key] = JSON.parse(localStorage.getItem(key));
            } catch {
                localData[key] = localStorage.getItem(key);
            }
        }
    }
}


// ======================================================
//  POPULATE DROPDOWN
// ======================================================
function populateDropdown() {
    const select = document.getElementById("tokoSelect");
    select.innerHTML = "";

    Object.keys(serverData).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name.replace("appData_", "").replace(".txt", "");
        select.appendChild(opt);
    });
}


// ======================================================
//  TAMPILKAN ISI DATA TOKO
// ======================================================
function showSelectedData() {
    const file = document.getElementById("tokoSelect").value;
    const area = document.getElementById("output");

    if (!file || !serverData[file]) {
        area.textContent = "Tidak ada data.";
        return;
    }

    area.textContent = serverData[file];
}


// ======================================================
//  DOWNLOAD SINGLE FILE
// ======================================================
function downloadSingle() {
    const file = document.getElementById("tokoSelect").value;
    if (!file) return alert("Pilih toko dulu.");

    triggerDownload(file, serverData[file]);
}

function triggerDownload(filename, text) {
    const blob = new Blob([text], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();

    URL.revokeObjectURL(url);
}


// ======================================================
//  DOWNLOAD SEMUA DALAM ZIP
// ======================================================
async function downloadAllAsZip() {
    const zip = new JSZip();

    Object.keys(serverData).forEach(name => {
        zip.file(name, serverData[name]);
    });

    const blob = await zip.generateAsync({ type: "blob" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "madgazan_backup_all.zip";
    a.click();
}


// ======================================================
//  SYNC LOCAL STORAGE → JSON
// ======================================================
function syncAllFiles() {
    loadLocalBackup();

    const merged = {};

    // isi lokal
    Object.keys(localData).forEach(k => {
        merged[k] = JSON.stringify(localData[k]);
    });

    // tambahkan yg belum ada dari server
    Object.keys(serverData).forEach(k => {
        if (!merged[k]) merged[k] = serverData[k];
    });

    const finalJson = JSON.stringify(merged, null, 2);

    triggerDownload("madgazan_backup_UPDATED.json", finalJson);
}


// ======================================================
//  CEK PERBEDAAN SERVER VS LOCAL STORAGE
// ======================================================
function checkForUpdates() {
    loadLocalBackup();

    let diff = [];

    Object.keys(serverData).forEach(file => {
        const serverFile = serverData[file];
        const localFile = localData[file] ? JSON.stringify(localData[file]) : null;

        if (serverFile !== localFile) {
            diff.push(file);
        }
    });

    document.getElementById("updateInfo").textContent =
        diff.length ? "File berbeda: " + diff.join(", ") : "Semua file sama.";
}


// ======================================================
//  PAGE LOAD
// ======================================================
window.onload = () => {
    loadLocalBackup();
    loadServerBackup();
};
</script>

</body>
</html>
